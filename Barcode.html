<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Barcode Scanner - Fox Control Hub</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    :root {
      --primary-color: #CC79F0;
      --secondary-color: #3E7EF7;
      --border-color: #F3F3F3;
      --success-color: #00B146;
      --danger-color: #CF2C3A;
      --warning-color: #FFA300;
      --main-bg: #FDFFFA;
      --bg-shadow: #F3F3F3;
      --table-row1: #F7F5FC;
      --table-row2: #F1EDF9;
      --table-bg: #F8F8F8;
      --bar-graph: #6E62BF;
      --confirmed: #1979FE;
      --header-color: #333135;
      --sub-header: #5F5B62;
      --tertiary-header: #2E2E38;
      --body-font: #4A4A4A;
      --pie-color1: #8979FF;
      --pie-color2: #FF928A;
      --pie-color3: #3CC3DF;
      --pie-color4: #FFAE4C;
      --pie-color5: #537FF1;
    }

    body {
      background-color: var(--main-bg);
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      font-size: 14px;
    }

    .sidebar {
      height: 100vh;
      background-color: var(--main-bg);
      border-right: 1px solid var(--border-color);
      position: sticky;
      top: 0;
      overflow-y: auto;
    }

    .sidebar .nav-link {
      color: var(--header-color);
      font-weight: 500;
      padding: 0.75rem 1rem;
      border-radius: 8px;
      margin: 2px 0;
      transition: all 0.3s ease;
    }

    .sidebar .nav-link:hover {
      background-color: var(--bg-shadow);
      color: var(--primary-color);
    }

    .sidebar .nav-link.active {
      background-color: var(--secondary-color);
      color: var(--main-bg);
    }

    .top-panel {
      background-color: var(--bg-shadow);
      border-radius: 15px;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .action-buttons .btn {
      margin: 0.25rem;
      min-width: 140px;
      font-weight: 500;
      background-color: var(--primary-color);
      color: white;
      border: none;
      border-radius: 8px;
      padding: 0.75rem;
      transition: all 0.3s ease;
    }

            .action-buttons .btn:hover {
            background-color: var(--tertiary-header);
            transform: translateY(-2px);
        }

    .action-buttons .btn i {
      font-size: 1.2rem;
      margin-right: 0.5rem;
    }

            .scanner-card {
            border: 2px solid var(--secondary-color);
            border-radius: 15px;
            padding: 1.5rem;
            background: var(--main-bg);
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }

            .scanner-card h5 {
            font-weight: bold;
            margin-bottom: 1.5rem;
            color: var(--secondary-color);
        }

    .scanner-area {
      background: var(--bg-shadow);
      border: 2px dashed var(--border-color);
      border-radius: 10px;
      padding: 2rem;
      text-align: center;
      margin-bottom: 1rem;
      min-height: 200px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
    }

    .scanner-area.active {
      border-color: var(--success-color);
      background-color: var(--table-row1);
    }

    .scanner-input {
      font-size: 1.2rem;
      text-align: center;
      border: 2px solid var(--secondary-color);
      border-radius: 8px;
      padding: 0.75rem;
      margin-bottom: 1rem;
    }

    .scanner-input:focus {
      border-color: var(--primary-color);
      box-shadow: 0 0 0 0.25rem rgba(209, 144, 0, 0.25);
    }

    .scan-result {
      background: var(--main-bg);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 1rem;
      margin-top: 1rem;
    }

    .scan-history {
      max-height: 300px;
      overflow-y: auto;
    }

    .scan-item {
      background: var(--bg-shadow);
      border-radius: 6px;
      padding: 0.75rem;
      margin-bottom: 0.5rem;
      border-left: 4px solid var(--primary-color);
    }

    .scan-item.barcode {
      border-left-color: var(--secondary-color);
    }

    .status-indicator {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      display: inline-block;
      margin-right: 0.5rem;
    }

    .status-ready {
      background-color: var(--success-color);
    }

    .status-scanning {
      background-color: var(--warning-color);
      animation: pulse 1s infinite;
    }

    .status-error {
      background-color: var(--danger-color);
    }

    @keyframes pulse {
      0% { opacity: 1; }
      50% { opacity: 0.5; }
      100% { opacity: 1; }
    }

    .scanner-controls {
      display: flex;
      gap: 0.5rem;
      justify-content: center;
      margin-bottom: 1rem;
    }

    .scanner-controls .btn {
      min-width: 100px;
    }

    /* Top Navigation */
    .top-navbar {
      background: linear-gradient(135deg, var(--main-bg) 0%, var(--bg-shadow) 100%);
      border-bottom: 1px solid var(--border-color);
      padding: 0.75rem 1.5rem;
      position: sticky;
      top: 0;
      z-index: 1030;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .top-navbar .navbar-brand {
      font-weight: bold;
      color: var(--primary-color);
      font-size: 1.25rem;
    }

    .top-navbar .navbar-nav .nav-link {
      color: var(--sub-header);
      font-weight: 500;
      padding: 0.5rem 1rem;
      border-radius: 6px;
      transition: all 0.3s ease;
    }

    .top-navbar .navbar-nav .nav-link:hover {
      background-color: var(--bg-shadow);
      color: var(--primary-color);
    }

    .notification-badge {
      position: absolute;
      top: -2px;
      right: -2px;
      background-color: var(--danger-color);
      color: white;
      border-radius: 50%;
      width: 18px;
      height: 18px;
      font-size: 0.7rem;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
    }

    .user-avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 600;
      font-size: 0.875rem;
    }

    .dropdown-menu {
      border: none;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      border-radius: 8px;
      padding: 0.5rem 0;
      min-width: 200px;
    }

    .dropdown-item {
      padding: 0.75rem 1.25rem;
      font-size: 0.875rem;
      transition: all 0.3s ease;
    }

    .dropdown-item:hover {
      background-color: var(--bg-shadow);
      color: var(--primary-color);
    }

    .dropdown-divider {
      margin: 0.5rem 0;
    }

    .notification-item {
      padding: 0.75rem 1.25rem;
      border-bottom: 1px solid var(--border-color);
      transition: all 0.3s ease;
    }

    .notification-item:hover {
      background-color: var(--bg-shadow);
    }

    .notification-item:last-child {
      border-bottom: none;
    }

    .notification-title {
      font-weight: 600;
      font-size: 0.875rem;
      color: var(--sub-header);
      margin-bottom: 0.25rem;
    }

    .notification-text {
      font-size: 0.75rem;
      color: var(--body-font);
      margin-bottom: 0.25rem;
    }

    .notification-time {
      font-size: 0.7rem;
      color: var(--body-font);
    }

    .notification-unread {
      background-color: var(--table-row1);
      border-left: 3px solid var(--primary-color);
    }

    /* Responsive adjustments for top nav */
    @media (max-width: 992px) {
      .top-navbar {
        padding: 0.5rem 1rem;
      }
      
      .user-avatar {
        width: 28px;
        height: 28px;
        font-size: 0.8rem;
      }
    }

    @media (max-width: 768px) {
      .action-buttons {
        flex-direction: column;
        align-items: stretch;
      }
      
      .action-buttons .btn {
        width: 100%;
        margin: 0.25rem 0;
      }
    }

    /* Item lookup modal styles */
    .item-details {
      background: #f8f9fa;
      border-radius: 8px;
      padding: 1rem;
      margin: 0.5rem 0;
    }

    .item-details strong {
      color: var(--primary-color);
    }

    .quantity-controls {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-top: 1rem;
    }

    .quantity-controls input {
      width: 80px;
      text-align: center;
    }

    .quantity-actions {
      margin-top: 1rem;
    }

    .quantity-actions .btn {
      margin: 0.25rem;
    }

    /* Item lookup modal styles */
    .item-details {
      background: #f8f9fa;
      border-radius: 8px;
      padding: 1rem;
      margin: 0.5rem 0;
    }

    .item-details strong {
      color: var(--primary-color);
    }

    .quantity-controls {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-top: 1rem;
    }

    .quantity-controls input {
      width: 80px;
      text-align: center;
    }

    .quantity-actions {
      margin-top: 1rem;
    }

    .quantity-actions .btn {
      margin: 0.25rem;
    }
    
    .barcode-section {
      border-top: 1px solid var(--border-color);
      padding-top: 1rem;
    }
    
    .barcode-item {
      text-align: center;
      padding: 0.5rem;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      background-color: var(--main-bg);
    }
    
    .barcode-display {
      margin: 0.5rem 0;
      min-height: 60px;
      display: flex;
      align-items: center;
      justify-content: center;
      background-color: white;
      border: 1px solid var(--border-color);
      border-radius: 4px;
    }
    
    .barcode-display canvas {
      max-width: 100%;
      height: auto;
    }
    
    .barcode-items-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 1rem;
      margin-top: 1rem;
    }
    
    .barcode-item-card {
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 1rem;
      background-color: var(--main-bg);
      transition: all 0.3s ease;
    }
    
    .barcode-item-card:hover {
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      transform: translateY(-2px);
    }
    
    .barcode-item-card h6 {
      margin-bottom: 0.5rem;
      color: var(--primary-color);
    }
    
    .barcode-item-card .item-info {
      font-size: 0.875rem;
      margin-bottom: 1rem;
    }
    
    .barcode-item-card .barcode-preview {
      text-align: center;
      margin: 1rem 0;
      padding: 0.5rem;
      background-color: white;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      min-height: 80px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .barcode-item-card .barcode-actions {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
    }
    
    /* Camera status and retry button styles */
    .manual-retry-btn {
      background-color: var(--warning-color);
      border-color: var(--warning-color);
      color: white;
      font-weight: 500;
      transition: all 0.3s ease;
    }
    
    .manual-retry-btn:hover {
      background-color: #e68900;
      border-color: #e68900;
      transform: translateY(-1px);
    }
    
    .camera-status-info {
      font-size: 0.8rem;
      color: var(--sub-header);
    }
    
    /* Video element improvements */
    .video-container {
      background: linear-gradient(45deg, #f0f0f0 25%, transparent 25%), 
                  linear-gradient(-45deg, #f0f0f0 25%, transparent 25%), 
                  linear-gradient(45deg, transparent 75%, #f0f0f0 75%), 
                  linear-gradient(-45deg, transparent 75%, #f0f0f0 75%);
      background-size: 20px 20px;
      background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
    }
    
    #barcodeVideo {
      min-height: 200px;
      background: transparent;
    }
    
    #barcodeVideo:not([srcObject]) {
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--sub-header);
      font-size: 0.9rem;
    }
    
    /* Camera overlay styles */
    #cameraOverlay {
      font-weight: 600;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
      transition: all 0.3s ease;
    }
    
    /* Video container improvements */
    .video-container {
      border: 2px solid var(--border-color);
      transition: all 0.3s ease;
    }
    
    .video-container:has(video[srcObject]) {
      border-color: var(--success-color);
      box-shadow: 0 0 10px rgba(0, 176, 70, 0.3);
    }
  </style>
</head>
<body>
<!-- Top Navigation -->
<nav class="navbar navbar-expand-lg top-navbar">
  <div class="container-fluid">
    <a class="navbar-brand" href="#">
      <i class="bi bi-boxes me-2"></i>Fox Control Hub
    </a>

    <!-- Right side navigation -->
    <div class="navbar-nav ms-auto d-flex flex-row align-items-center">
      <!-- Search (hidden on mobile) -->
      <div class="nav-item me-3 d-none d-lg-block">
        <div class="input-group" style="width: 250px;">
        </div>
      </div>

      <!-- Notifications -->
      <div class="nav-item dropdown me-3">
        <a class="nav-link position-relative" href="#" id="notificationDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
          <i class="bi bi-bell fs-5"></i>
          <span class="notification-badge" id="notificationCount" style="display: none;">0</span>
        </a>
        <div class="dropdown-menu dropdown-menu-end" aria-labelledby="notificationDropdown" style="width: 320px;">
          <div class="d-flex justify-content-between align-items-center px-3 py-2 border-bottom">
            <h6 class="mb-0">Notifications</h6>
            <button class="btn btn-sm btn-link text-primary p-0" onclick="markAllAsRead()">Mark all as read</button>
          </div>
          <div class="notification-list" id="notificationList" style="max-height: 300px; overflow-y: auto;">
            <!-- Dynamic notifications will be loaded here -->
            <div class="text-center py-3" id="noNotifications" style="display: none;">
              <i class="bi bi-bell-slash text-muted fs-4"></i>
              <div class="text-muted mt-2">No notifications yet</div>
            </div>
          </div>
          <div class="text-center py-2 border-top">
            <a href="#" class="btn btn-sm btn-link">View all notifications</a>
          </div>
        </div>
      </div>

      <!-- Messages -->
      <div class="nav-item dropdown me-3">
        <a class="nav-link position-relative" href="#" id="messageDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
          <i class="bi bi-chat-dots fs-5"></i>
          <span class="notification-badge" style="background-color: var(--success-color);">2</span>
        </a>
        <div class="dropdown-menu dropdown-menu-end" aria-labelledby="messageDropdown" style="width: 300px;">
          <div class="d-flex justify-content-between align-items-center px-3 py-2 border-bottom">
            <h6 class="mb-0">Messages</h6>
            <a href="#" class="btn btn-sm btn-link text-primary p-0">View all</a>
          </div>
          <div class="notification-list" style="max-height: 250px; overflow-y: auto;">
            <div class="notification-item">
              <div class="d-flex align-items-center">
                <div class="user-avatar me-2" style="width: 24px; height: 24px; font-size: 0.7rem;">JD</div>
                <div class="flex-grow-1">
                  <div class="notification-title">John Doe</div>
                  <div class="notification-text">Can you check the inventory levels for electronics?</div>
                  <div class="notification-time">5 minutes ago</div>
                </div>
              </div>
            </div>
            <div class="notification-item">
              <div class="d-flex align-items-center">
                <div class="user-avatar me-2" style="width: 24px; height: 24px; font-size: 0.7rem;">SM</div>
                <div class="flex-grow-1">
                  <div class="notification-title">Sarah Miller</div>
                  <div class="notification-text">New shipment arrived at warehouse WH001</div>
                  <div class="notification-time">1 hour ago</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- User Profile -->
    <div class="nav-item dropdown">
      <a class="nav-link d-flex align-items-center" href="#" id="userDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
        <div class="user-avatar me-2" id="userAvatar"></div>
        <div class="d-none d-md-block">
          <div id="userName" style="font-size: 0.875rem; font-weight: 600; line-height: 1.2;"></div>
        </div>
        <i class="bi bi-chevron-down ms-2"></i>
      </a>
      <div class="dropdown-menu dropdown-menu-end" aria-labelledby="userDropdown">
        <div class="px-3 py-2 border-bottom">
          <div class="fw-bold" id="userFullNameDropdown"></div>
          <div class="text-muted small" id="userEmailDropdown"></div>
        </div>
        <a class="dropdown-item" href="#" onclick="showSettingsModal()">
          <i class="bi bi-gear me-2"></i>Settings
        </a>
        <a class="dropdown-item" href="#">
          <i class="bi bi-question-circle me-2"></i>Help & Support
        </a>
        <div class="dropdown-divider"></div>
        <a class="dropdown-item" href="#" onclick="showActivityLog()">
          <i class="bi bi-clock-history me-2"></i>Activity Log
        </a>
        <a class="dropdown-item" href="#">
          <i class="bi bi-shield-check me-2"></i>Security
        </a>
        <div class="dropdown-divider"></div>
        <a class="dropdown-item text-danger" href="#" onclick="logout()">
          <i class="bi bi-box-arrow-right me-2"></i>Sign Out
        </a>
      </div>  
    </div>
  </div>
</nav>

<div class="container-fluid">
  <div class="row">
    <!-- Sidebar -->
    <div class="col-lg-2 col-md-3 sidebar p-3">
      <nav class="nav flex-column">
        <a class="nav-link" href="Inventory.html"><i class="bi bi-box-seam me-2"></i>Inventory</a>
        <a class="nav-link active" href="Barcode.html"><i class="bi bi-upc-scan me-2"></i>Barcode</a>
        <a class="nav-link" href="WarehouseLayAndOpti.html"><i class="bi bi-layout-wtf me-2"></i>Layout & Optimization</a>
        <a class="nav-link" href="OrderShipments.html"><i class="bi bi-box-arrow-right me-2"></i>Order Shipments</a>
        <a class="nav-link" href="StockTracking.html"><i class="bi bi-shop me-2"></i>Stock Tracking</a>
        <a class="nav-link" href="Reports.html"><i class="bi bi-graph-up me-2"></i>Reports</a>
      </nav>
    </div>

    <!-- Main Content -->
    <div class="col-lg-10 col-md-9 p-3">
      <!-- Top Panel -->
      <div class="top-panel">
        <h4 class="fw-bold">Barcode Scanner</h4>
        <div class="d-flex flex-wrap justify-content-start action-buttons">
          <button class="btn" onclick="startBarcodeScanner()">
            <i class="bi bi-upc-scan"></i>Start Barcode Scanner
          </button>

          <button class="btn" onclick="exportScanHistory()">
            <i class="bi bi-download"></i>Export History
          </button>
          <button class="btn" onclick="clearScanHistory()">
            <i class="bi bi-trash"></i>Clear History
          </button>
          <button class="btn" onclick="loadInventoryData()">
            <i class="bi bi-arrow-clockwise"></i>Refresh Data
          </button>
          <button class="btn" onclick="loadScanHistoryFromDatabase()">
            <i class="bi bi-database"></i>Load History
          </button>
        </div>
      </div>

      <!-- Scanner Section -->
      <div class="scanner-card">
        <h5><i class="bi bi-camera me-2"></i>Scanner Interface</h5>
        
        <!-- Scanner Status -->
        <div class="mb-3">
          <span class="status-indicator status-ready" id="statusIndicator"></span>
          <span id="statusText">Ready to scan</span>
          <div class="mt-1">
            <small class="text-muted">
              <span id="cameraStatus">Camera: Not active</span>
              <span id="cameraInfo" class="ms-3" style="display: none;"></span>
            </small>
          </div>
        </div>

        <!-- Scanner Controls -->
        <div class="scanner-controls">
          <button class="btn btn-outline-success" onclick="continuousScan()" id="continuousBtn">
            <i class="bi bi-arrow-repeat"></i> Continuous Scan
          </button>
          <button class="btn btn-outline-info btn-sm" onclick="debugCameraState()" title="Debug camera state">
            <i class="bi bi-bug"></i> Debug
          </button>
          <button class="btn btn-outline-warning btn-sm" onclick="testCameraDisplay()" title="Test camera display">
            <i class="bi bi-camera"></i> Test Camera
          </button>
        </div>

        <!-- Scanner Area -->
        <div class="scanner-area" id="scannerArea">
          <div class="video-container" style="position: relative; width: 100%; max-height: 260px; border-radius: 8px; overflow: hidden; background: #000;">
            <video id="barcodeVideo" autoplay playsinline muted style="width: 100%; height: 100%; object-fit: cover; border-radius: 8px;">
              <!-- Fallback content for browsers that don't support video -->
              <div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #666; font-size: 0.9rem;">
                Camera not active. Click "Start Barcode Scanner" to begin.
              </div>
            </video>
            <!-- Camera status overlay -->
            <div id="cameraOverlay" style="position: absolute; top: 10px; right: 10px; background: rgba(0,0,0,0.7); color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem; display: none;">
              Camera Active
            </div>
          </div>
          <div class="mt-2">
            <h6>Point camera at barcode</h6>
            <p class="text-muted">Or manually enter code below</p>
          </div>
          <!-- Manual retry button will be added here dynamically -->
        </div>

        <!-- Manual Input -->
        <input type="text" class="form-control scanner-input" id="manualInput" 
               placeholder="Scan or type barcode code here..." 
               onkeypress="handleManualInput(event)">

        <!-- Current Scan Result -->
        <div class="scan-result" id="scanResult" style="display: none;">
          <h6>Scan Result:</h6>
          <div id="resultContent"></div>
        </div>
      </div>

      <!-- Scan History -->
      <div class="scanner-card">
        <h5><i class="bi bi-clock-history me-2"></i>Scan History</h5>
        <div class="d-flex justify-content-between align-items-center mb-3">
          <span class="text-muted">Total scans: <span id="scanCount">0</span></span>
          <div>
            <button class="btn btn-sm btn-outline-primary" onclick="filterHistory('barcode')">Barcode</button>
          </div>
        </div>
        
        <div class="scan-history" id="scanHistory">
          <div class="text-center text-muted py-4">
            <i class="bi bi-inbox" style="font-size: 2rem;"></i>
            <p>No scans yet. Start scanning to see history here.</p>
          </div>
        </div>
      </div>
      
      <!-- Barcode Generation Section -->
      <div class="scanner-card">
        <h5><i class="bi bi-upc-scan me-2"></i>Inventory Barcode Generator</h5>
        <p class="text-muted">Generate barcodes for inventory items</p>
        
        <div class="row g-3 mb-3">
          <div class="col-md-4">
            <label class="form-label">Search Items</label>
            <input type="text" class="form-control" id="barcodeSearchInput" 
                   placeholder="Search by name or code..." onkeyup="filterBarcodeItems()">
          </div>
          <div class="col-md-4">
            <label class="form-label">Category</label>
            <select class="form-select" id="barcodeCategoryFilter" onchange="filterBarcodeItems()">
              <option value="">All Categories</option>
            </select>
          </div>
          <div class="col-md-4">
            <label class="form-label">Warehouse</label>
            <select class="form-select" id="barcodeWarehouseFilter" onchange="filterBarcodeItems()">
              <option value="">All Warehouses</option>
            </select>
            </div>
        </div>
        
        <div class="barcode-items-grid" id="barcodeItemsGrid">
          <div class="text-center text-muted py-4">
            <i class="bi bi-upc-scan" style="font-size: 2rem;"></i>
            <p>Loading inventory items...</p>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Item Lookup Modal -->
<div class="modal fade" id="itemLookupModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header" style="background-color: var(--primary-color); color: white;">
        <h5 class="modal-title">Item Details</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div id="itemDetailsContent">
          <!-- Item details will be loaded here -->
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary" onclick="updateInventoryQuantity()">Update Quantity</button>
      </div>
    </div>
  </div>
</div>

<!-- Settings Modal -->
<div class="modal fade" id="settingsModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header" style="background-color: var(--primary-color); color: white;">
        <h5 class="modal-title">Scanner Settings</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="row g-4">
          <!-- Scanner Settings -->
          <div class="col-12">
            <h6 class="border-bottom pb-2 mb-3">Scanner Configuration</h6>
            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label">Default Scanner Mode</label>
                <select class="form-select" id="defaultScannerMode">
                  <option value="barcode" selected>Barcode</option>
                </select>
              </div>
              <div class="col-md-6">
                <label class="form-label">Scan Timeout (seconds)</label>
                <input type="number" class="form-control" id="scanTimeout" value="30" min="10" max="120">
              </div>
              <div class="col-md-6">
                <div class="form-check form-switch">
                  <input class="form-check-input" type="checkbox" id="autoLookup" checked>
                  <label class="form-check-label" for="autoLookup">
                    Auto-lookup items after scan
                  </label>
                </div>
              </div>
              <div class="col-md-6">
                <div class="form-check form-switch">
                  <input class="form-check-input" type="checkbox" id="playBeepSound" checked>
                  <label class="form-check-label" for="playBeepSound">
                    Play beep sound on successful scan
                  </label>
                </div>
              </div>
            </div>
          </div>

          <!-- Display Settings -->
          <div class="col-12">
            <h6 class="border-bottom pb-2 mb-3">Display Settings</h6>
            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label">History Display Limit</label>
                <select class="form-select" id="historyLimit">
                  <option value="50">50 items</option>
                  <option value="100" selected>100 items</option>
                  <option value="200">200 items</option>
                  <option value="500">500 items</option>
                </select>
              </div>
              <div class="col-md-6">
                <label class="form-label">Date Format</label>
                <select class="form-select" id="dateFormat">
                  <option value="mm/dd/yyyy">MM/DD/YYYY</option>
                  <option value="dd/mm/yyyy" selected>DD/MM/YYYY</option>
                  <option value="yyyy-mm-dd">YYYY-MM-DD</option>
                </select>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" onclick="saveSettings()">Save Settings</button>
      </div>
    </div>
  </div>
</div>

<!-- Profile Modal -->
<div class="modal fade" id="profileModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header" style="background-color: var(--primary-color); color: white;">
        <h5 class="modal-title">My Profile</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="row g-4">
          <div class="col-md-4 text-center">
            <div class="user-avatar mx-auto mb-3" style="width: 80px; height: 80px; font-size: 2rem;" id="profileAvatar">SC</div>
            <button class="btn btn-outline-primary btn-sm">Change Avatar</button>
          </div>
          <div class="col-md-8">
            <form id="profileForm">
              <div class="row g-3">
                <div class="col-md-6">
                  <label class="form-label">First Name</label>
                  <input type="text" class="form-control" value="Scanner" id="firstName">
                </div>
                <div class="col-md-6">
                  <label class="form-label">Last Name</label>
                  <input type="text" class="form-control" value="Operator" id="lastName">
                </div>
                <div class="col-12">
                  <label class="form-label">Email</label>
                  <input type="email" class="form-control" value="scanner@foxcontrolhub.com" id="email">
                </div>
                <div class="col-md-6">
                  <label class="form-label">Phone</label>
                  <input type="tel" class="form-control" value="+1 (555) 987-6543" id="phone">
                </div>
                <div class="col-md-6">
                  <label class="form-label">Department</label>
                  <select class="form-select" id="department">
                    <option value="warehouse" selected>Warehouse Operations</option>
                    <option value="inventory">Inventory Management</option>
                    <option value="quality">Quality Control</option>
                    <option value="shipping">Shipping & Receiving</option>
                  </select>
                </div>
              </div>
            </form>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" onclick="saveProfile()">Save Changes</button>
      </div>
    </div>
  </div>
</div>

<!-- Activity Log Modal -->
<div class="modal fade" id="activityModal" tabindex="-1">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header" style="background-color: var(--primary-color); color: white;">
        <h5 class="modal-title">Scanning Activity Log</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="table-responsive">
          <table class="table table-hover">
            <thead>
              <tr>
                <th>Timestamp</th>
                <th>Action</th>
                <th>Code</th>
                <th>Type</th>
                <th>Item</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody id="activityLogBody">
              <!-- Activity log will be populated dynamically -->
            </tbody>
          </table>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary" onclick="exportActivityLog()">Export Log</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://unpkg.com/@zxing/library@0.20.0"></script>
<script>
// Check if ZXing library loaded successfully
window.addEventListener('load', function() {
  setTimeout(() => {
    if (!window.ZXing || !ZXing.BrowserMultiFormatReader) {
      console.error('‚ùå ZXing library failed to load');
      showMessage('Barcode scanning library failed to load. Please check your internet connection and refresh the page.', 'error');
      updateCameraStatus('Library failed to load');
    } else {
      console.log('‚úÖ ZXing library loaded successfully');
    }
  }, 2000); // Wait 2 seconds for library to load
});
// Global variables
let scanHistory = [];
let inventoryData = [];
let categoriesData = [];
let warehousesData = [];
let currentItem = null;
let isScanning = false;
let scannerMode = 'barcode';
let continuousMode = false;
let scanTimeout = 30;
let autoLookup = true;
let playBeepSound = true;
let currentUser = null;
let codeReader = null;
let activeVideoElement = null;
let lastScannedAt = 0;
let lastScannedCode = '';
let cameraStream = null;
let isCameraActive = false;

// API Helper Functions
const API_BASE = '/api';

async function apiCall(endpoint, options = {}) {
  try {
    const response = await fetch(`${API_BASE}${endpoint}`, {
      ...options,
      headers: {
        'Content-Type': 'application/json',
        ...options.headers
      }
    });
    
    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }
    
    return await response.json();
  } catch (error) {
    console.error('API call failed:', error);
    throw error;
  }
}

// Initialize scanner
document.addEventListener('DOMContentLoaded', function() {
  loadInitialData();
  fetchUser();
  loadNotifications();
  loadNotificationCount();
  updateScanCount();
  focusInput();
  
  // Initialize video placeholder
  initializeVideoPlaceholder();
  
  // Initialize video element
  initializeVideoElement();
  
  // Check camera availability
  checkCameraAvailability().then(result => {
    if (!result.available) {
      console.warn('‚ö†Ô∏è Camera not available:', result.reason);
      updateCameraStatus('Not available', result.reason);
    }
  });
});

function initializeVideoPlaceholder() {
  const videoContainer = document.querySelector('.video-container');
  const video = document.getElementById('barcodeVideo');
  
  if (videoContainer && video) {
    // Add a placeholder overlay when video is not active
    const placeholder = document.createElement('div');
    placeholder.id = 'videoPlaceholder';
    placeholder.style.cssText = `
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(0,0,0,0.8);
      color: white;
      font-size: 0.9rem;
      text-align: center;
      border-radius: 8px;
      z-index: 1;
    `;
    placeholder.innerHTML = `
      <div>
        <i class="bi bi-camera" style="font-size: 2rem; margin-bottom: 0.5rem;"></i><br>
        Camera not active<br>
        <small>Click "Start Barcode Scanner" to begin</small>
      </div>
    `;
    
    // Add placeholder to the container, not the video element
    videoContainer.appendChild(placeholder);
    
    // Remove placeholder when video becomes active
    video.addEventListener('loadedmetadata', function() {
      if (placeholder.parentNode) {
        placeholder.remove();
      }
    });
  }
}

function initializeVideoElement() {
  const video = document.getElementById('barcodeVideo');
  if (video) {
    // Ensure video element has proper initial state
    video.style.display = 'block';
    video.style.minHeight = '200px';
    video.style.width = '100%';
    video.style.height = '100%';
    video.style.objectFit = 'cover';
    
    // Add event listeners for better debugging
    video.addEventListener('loadstart', () => console.log('üìπ Video loadstart event'));
    video.addEventListener('loadedmetadata', () => console.log('üìπ Video loadedmetadata event'));
    video.addEventListener('loadeddata', () => console.log('üìπ Video loadeddata event'));
    video.addEventListener('canplay', () => console.log('üìπ Video canplay event'));
    video.addEventListener('canplaythrough', () => console.log('üìπ Video canplaythrough event'));
    video.addEventListener('playing', () => console.log('üìπ Video playing event'));
    
    console.log('‚úÖ Video element initialized');
  }
}

function showVideoPlaceholder() {
  const videoContainer = document.querySelector('.video-container');
  if (videoContainer && !videoContainer.querySelector('#videoPlaceholder')) {
    const placeholder = document.createElement('div');
    placeholder.id = 'videoPlaceholder';
    placeholder.style.cssText = `
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(0,0,0,0.8);
      color: white;
      font-size: 0.9rem;
      text-align: center;
      border-radius: 8px;
      z-index: 1;
    `;
    placeholder.innerHTML = `
      <div>
        <i class="bi bi-camera" style="font-size: 2rem; margin-bottom: 0.5rem;"></i><br>
        Camera not active<br>
        <small>Click "Start Barcode Scanner" to begin</small>
      </div>
    `;
    
    videoContainer.appendChild(placeholder);
  }
}

function showCameraOverlay(show) {
  const overlay = document.getElementById('cameraOverlay');
  if (overlay) {
    if (show) {
      overlay.style.display = 'block';
      overlay.textContent = 'Camera Active';
      overlay.style.background = 'rgba(0, 128, 0, 0.8)'; // Green background
    } else {
      overlay.style.display = 'none';
    }
  }
}

async function checkCameraAvailability() {
  try {
    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
      console.warn('‚ö†Ô∏è Media devices API not supported');
      return { available: false, reason: 'Media devices API not supported' };
    }
    
    const devices = await navigator.mediaDevices.enumerateDevices();
    const videoDevices = devices.filter(device => device.kind === 'videoinput');
    
    if (videoDevices.length === 0) {
      console.warn('‚ö†Ô∏è No video input devices found');
      return { available: false, reason: 'No video input devices found' };
    }
    
    console.log('üì± Found video devices:', videoDevices.map(d => ({
      deviceId: d.deviceId,
      label: d.label,
      groupId: d.groupId
    })));
    
    return { available: true, devices: videoDevices };
  } catch (error) {
    console.error('‚ùå Error checking camera availability:', error);
    return { available: false, reason: error.message };
  }
}

function debugCameraState() {
  console.log('üîç Camera Debug Information:');
  console.log('üì± Navigator media devices:', !!navigator.mediaDevices);
  console.log('üì± getUserMedia support:', !!navigator.mediaDevices?.getUserMedia);
  console.log('üì± enumerateDevices support:', !!navigator.mediaDevices?.enumerateDevices);
  console.log('üìπ Video element:', document.getElementById('barcodeVideo'));
  console.log('üìπ Video srcObject:', document.getElementById('barcodeVideo')?.srcObject);
  console.log('üìπ Video readyState:', document.getElementById('barcodeVideo')?.readyState);
  console.log('üìπ Video networkState:', document.getElementById('barcodeVideo')?.networkState);
  console.log('üìπ Video error:', document.getElementById('barcodeVideo')?.error);
  console.log('üîç ZXing library:', !!window.ZXing);
  console.log('üîç BrowserMultiFormatReader:', !!window.ZXing?.BrowserMultiFormatReader);
  console.log('üîç Code reader instance:', !!codeReader);
  console.log('üîç Camera active:', isCameraActive);
  console.log('üîç Camera stream:', !!cameraStream);
  console.log('üîç Active video element:', !!activeVideoElement);
  console.log('üîç Is scanning:', isScanning);
  console.log('üîç Scanner mode:', scannerMode);
  console.log('üîç Continuous mode:', continuousMode);
}

async function testCameraDisplay() {
  console.log('üß™ Testing camera display...');
  
  try {
    // Get a simple test stream
    const testStream = await navigator.mediaDevices.getUserMedia({ 
      video: { 
        width: { ideal: 640 },
        height: { ideal: 480 }
      } 
    });
    
    const video = document.getElementById('barcodeVideo');
    if (video) {
      // Set the test stream
      video.srcObject = testStream;
      
      // Show camera overlay
      showCameraOverlay(true);
      updateCameraStatus('Test Active', 'Testing camera display');
      
      // Remove placeholder
      const placeholder = document.querySelector('#videoPlaceholder');
      if (placeholder) {
        placeholder.remove();
      }
      
      console.log('‚úÖ Test camera stream started');
      showMessage('Test camera stream started. Check if you can see the camera feed.', 'success');
      
      // Stop test after 5 seconds
      setTimeout(() => {
        testStream.getTracks().forEach(track => track.stop());
        video.srcObject = null;
        showCameraOverlay(false);
        updateCameraStatus('Not active');
        showVideoPlaceholder();
        console.log('‚úÖ Test camera stream stopped');
        showMessage('Test camera stream stopped.', 'info');
      }, 5000);
      
    } else {
      console.error('‚ùå Video element not found');
      showMessage('Video element not found', 'error');
    }
    
  } catch (error) {
    console.error('‚ùå Test camera failed:', error);
    showMessage(`Test camera failed: ${error.message}`, 'error');
  }
}

// Load initial data from database
async function loadInitialData() {
  try {
    showLoading(true);
    const [inventoryResponse, categoriesResponse, warehousesResponse] = await Promise.all([
      apiCall('/inventory'),
      apiCall('/categories'),
      apiCall('/warehouses')
    ]);
    
    if (inventoryResponse.success) {
      inventoryData = mapInventoryData(inventoryResponse.data);
      
          // After loading inventory, load scan history from database
    await loadScanHistoryFromDatabase();
    
    // Populate barcode generation section
    populateBarcodeItems();
    populateBarcodeFilters();
  }
    
    if (categoriesResponse.success) {
      categoriesData = categoriesResponse.data;
    }
    
    if (warehousesResponse.success) {
      warehousesData = warehousesResponse.data;
    }
    
  } catch (error) {
    console.error('Error loading initial data:', error);
    showMessage('Error loading data from database. Operating in offline mode.', 'warning');
  } finally {
    showLoading(false);
  }
}

// Map raw inventory data to internal format
function mapInventoryData(rawData) {
  return rawData.map(item => ({
    id: item.id,
    itemCode: item.item_code,
    productId: item.product_id,
    productName: item.product_name,
    productDescription: item.product_description,
    productCategory: item.product_category,
    productImage: item.product_image,
    price: item.price,
    unitOfMeasure: item.unit_of_measure,
    categoryId: item.category_id,
    status: item.status,
    warehouseId: item.warehouse_id,
    totalQuantity: item.total_quantity,
    updatedAt: item.updated_at
  }));
}

function showLoading(show) {
  const statusText = document.getElementById('statusText');
  if (show) {
    statusText.textContent = 'Loading data...';
    updateStatus('scanning', 'Loading data...');
  } else {
    statusText.textContent = 'Ready to scan';
    updateStatus('ready', 'Ready to scan');
  }
}

function showMessage(message, type = 'info') {
  // Create notification if needed
  addNotification(message, type);
  
  // Show temporary toast-like message
  const alertDiv = document.createElement('div');
  alertDiv.className = `alert alert-${type === 'error' ? 'danger' : type === 'warning' ? 'warning' : 'success'} alert-dismissible fade show position-fixed`;
  alertDiv.style.cssText = 'top: 80px; right: 20px; z-index: 9999; min-width: 300px;';
  alertDiv.innerHTML = `
    ${message}
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
  `;
  
  document.body.appendChild(alertDiv);
  
  // Auto-remove after 5 seconds
  setTimeout(() => {
    if (alertDiv.parentNode) {
      alertDiv.remove();
    }
  }, 5000);
}

function startBarcodeScanner() {
  scannerMode = 'barcode';
  startScanning();
  startCameraBarcodeScanner();
}

function updateScannerMode() {
  // Update UI to reflect current scanner mode
  const scannerArea = document.getElementById('scannerArea');
  if (scannerArea) {
    scannerArea.classList.remove('active');
    if (isScanning) {
      scannerArea.classList.add('active');
    }
  }
}


function startScanning() {
  isScanning = true;
  updateStatus('scanning', `Scanning for ${scannerMode.toUpperCase()}...`);
  document.getElementById('scannerArea').classList.add('active');
  focusInput();
  
  // Auto-stop scanning after timeout
  setTimeout(() => {
    if (isScanning && !continuousMode) {
      stopScanning();
    }
  }, scanTimeout * 1000);
}

function stopScanning() {
  isScanning = false;
  updateStatus('ready', 'Scanner stopped');
  document.getElementById('scannerArea').classList.remove('active');
  stopCameraBarcodeScanner();
}
  
function continuousScan() {
  continuousMode = !continuousMode;
  const btn = document.getElementById('continuousBtn');
  
  if (continuousMode) {
    btn.innerHTML = '<i class="bi bi-pause"></i> Stop Continuous';
    btn.classList.remove('btn-outline-success');
    btn.classList.add('btn-success');
    startScanning();
    startCameraBarcodeScanner();
  } else {
    btn.innerHTML = '<i class="bi bi-arrow-repeat"></i> Continuous Scan';
    btn.classList.remove('btn-success');
    btn.classList.add('btn-outline-success');
    stopScanning();
  }
}

function handleManualInput(event) {
  if (event.key === 'Enter') {
    const input = event.target;
    const code = input.value.trim();
    
    if (code) {
      processScan(code, scannerMode);
      input.value = '';
      
      if (!continuousMode) {
        stopScanning();
      }
    }
  }
}

async function processScan(code, type) {
  const timestamp = new Date();
  const scanData = {
    id: Date.now(),
    code: code,
    type: type,
    timestamp: timestamp,
    status: 'success',
    item: null
  };
  
  // Try to find item in inventory using multiple barcode formats
  if (inventoryData.length > 0) {
    const foundItem = inventoryData.find(item => {
      // Check exact item code match
      if (item.itemCode === code) return true;
      
      // Check ID match
      if (item.id.toString() === code) return true;
      
      // Check combined format (itemCode-id)
      if (`${item.itemCode}-${item.id}` === code) return true;
      
      // Check if code contains item code (for partial matches)
      if (code.includes(item.itemCode)) return true;
      
      // Check if item code contains the scanned code (for partial matches)
      if (item.itemCode.includes(code)) return true;
      
      return false;
    });
    
    if (foundItem) {
      scanData.item = foundItem;
      scanData.status = 'found';
      scanData.itemId = foundItem.id;
      scanData.productName = foundItem.productName;
      scanData.quantity = foundItem.totalQuantity;
    } else {
      scanData.status = 'not_found';
    }
  }
  
  // Save to database
  try {
    console.log('Attempting to save scan to database:', { currentUser, scanData });
    
    const dbScanData = {
      code: code,
      type: type,
      itemId: scanData.itemId || null,
      productName: scanData.productName || null,
      quantity: scanData.quantity || 1,
      status: scanData.status,
      scannedBy: currentUser?.username || 'unknown',
      notes: `Scanned at ${timestamp.toLocaleString()}`
    };
    
    console.log('Sending scan data to database:', dbScanData);
    
    // Try to save to database
    const savedScan = await apiCall('/scan-history', {
      method: 'POST',
      body: JSON.stringify(dbScanData)
    });
    
    console.log('Database save response:', savedScan);
    
    if (savedScan.success) {
      scanData.dbId = savedScan.data.id;
      scanData.dbCreatedAt = savedScan.data.created_at;
      console.log('Scan saved to database successfully');
    } else {
      console.log('Database save failed:', savedScan);
    }
  } catch (error) {
    console.error('Error saving scan to database:', error);
    // Continue with local storage if database fails
  }
  
  // Add to local history
  scanHistory.unshift(scanData);
  
  // Limit history size
  const historyLimit = parseInt(document.getElementById('historyLimit')?.value || 100);
  if (scanHistory.length > historyLimit) {
    scanHistory = scanHistory.slice(0, historyLimit);
  }
  
  // Show result
  showScanResult(scanData);
  
  // Update history display
  updateScanHistory();
  updateScanCount();
  
  // Auto-lookup if enabled
  if (autoLookup && scanData.item) {
    setTimeout(() => lookupItem(code), 1000);
  }
  
  // Play success sound
  if (playBeepSound) {
    playBeep();
  }
  
  // Log activity
  logActivity('scan', code, type, scanData.item?.productName || 'Unknown', scanData.status);
}

// Barcode generation function
function generateBarcode(text, elementId) {
  try {
    // Simple barcode generation using canvas
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    const width = 200;
    const height = 60;
    
    canvas.width = width;
    canvas.height = height;
    
    // Clear canvas
    ctx.fillStyle = 'white';
    ctx.fillRect(0, 0, width, height);
    
    // Draw barcode bars (simple representation)
    ctx.fillStyle = 'black';
    const barWidth = 2;
    let x = 10;
    
    for (let i = 0; i < text.length; i++) {
      const charCode = text.charCodeAt(i);
      const barHeight = (charCode % 3 + 1) * 15 + 10;
      const y = (height - barHeight) / 2;
      
      ctx.fillRect(x, y, barWidth, barHeight);
      x += barWidth + 1;
      
      // Add some spacing between characters
      if (i < text.length - 1) {
        x += 2;
      }
    }
    
    // Add text below barcode
    ctx.fillStyle = 'black';
    ctx.font = '12px monospace';
    ctx.textAlign = 'center';
    ctx.fillText(text, width / 2, height - 5);
    
    // Display the barcode
    const barcodeDiv = document.getElementById(`barcode-${elementId}`);
    if (barcodeDiv) {
      barcodeDiv.innerHTML = '';
      barcodeDiv.appendChild(canvas);
    }
    
    showMessage(`Barcode generated for: ${text}`, 'success');
  } catch (error) {
    console.error('Error generating barcode:', error);
    showMessage('Error generating barcode', 'error');
  }
}

function showScanResult(scanData) {
  const resultDiv = document.getElementById('scanResult');
  const contentDiv = document.getElementById('resultContent');
  
  let statusBadge, statusText, itemInfo = '';
  
  switch(scanData.status) {
    case 'found':
      statusBadge = '<span class="badge bg-success">Item Found</span>';
      statusText = 'Item found in inventory';
      itemInfo = `
        <div class="mt-2">
          <strong>Product:</strong> ${scanData.item.productName}<br>
          <strong>Category:</strong> ${scanData.item.productCategory || '-'}<br>
          <strong>Quantity:</strong> ${scanData.item.totalQuantity}
        </div>
      `;
      break;
    case 'not_found':
      statusBadge = '<span class="badge bg-warning">Not Found</span>';
      statusText = 'Item not found in inventory';
      break;
    default:
      statusBadge = '<span class="badge bg-info">Scanned</span>';
      statusText = 'Code scanned successfully';
  }
  
  contentDiv.innerHTML = `
    <div class="row">
      <div class="col-md-6">
        <strong>Code:</strong> ${scanData.code}<br>
        <strong>Type:</strong> ${scanData.type.toUpperCase()}<br>
        <strong>Time:</strong> ${scanData.timestamp.toLocaleTimeString()}
        ${itemInfo}
      </div>
      <div class="col-md-6">
        <strong>Status:</strong> ${statusBadge}<br>
        <small class="text-muted">${statusText}</small><br>
        <div class="mt-2">
          <button class="btn btn-sm btn-primary me-2" onclick="lookupItem('${scanData.code}')">
            <i class="bi bi-search"></i> Lookup
          </button>
          ${scanData.item ? `<button class="btn btn-sm btn-success" onclick="quickUpdate('${scanData.code}')">
            <i class="bi bi-pencil"></i> Quick Update
          </button>` : ''}
        </div>
      </div>
    </div>
  `;
  
  resultDiv.style.display = 'block';
  
  // Auto-hide after 10 seconds
  setTimeout(() => {
    resultDiv.style.display = 'none';
  }, 10000);
}

function updateScanHistory() {
  const historyDiv = document.getElementById('scanHistory');
  
  if (scanHistory.length === 0) {
    historyDiv.innerHTML = `
      <div class="text-center text-muted py-4">
        <i class="bi bi-inbox" style="font-size: 2rem;"></i>
        <p>No scans yet. Start scanning to see history here.</p>
      </div>
    `;
    return;
  }
  
  historyDiv.innerHTML = scanHistory.map(scan => {
    let statusIcon, statusClass;
    
    switch(scan.status) {
      case 'found':
        statusIcon = '<i class="bi bi-check-circle-fill text-success"></i>';
        statusClass = 'border-success';
        break;
      case 'not_found':
        statusIcon = '<i class="bi bi-exclamation-triangle-fill text-warning"></i>';
        statusClass = 'border-warning';
        break;
      default:
        statusIcon = '<i class="bi bi-info-circle-fill text-info"></i>';
        statusClass = '';
    }
    
    return `
      <div class="scan-item ${scan.type} ${statusClass}" data-type="${scan.type}">
        <div class="d-flex justify-content-between align-items-start">
          <div class="flex-grow-1">
            <div class="d-flex align-items-center mb-1">
              ${statusIcon}
              <strong class="ms-2">${scan.code}</strong>
              ${scan.item ? `<span class="badge bg-info ms-2">${scan.item.productName}</span>` : ''}
            </div>
            <small class="text-muted">
              <i class="bi bi-${scan.type === 'barcode' ? 'upc-scan' : 'broadcast'}"></i>
              ${scan.type.toUpperCase()} ‚Ä¢ ${scan.timestamp.toLocaleString()}
              ${scan.item ? ` ‚Ä¢ Qty: ${scan.item.totalQuantity}` : ''}
            </small>
          </div>
          <div>
            <button class="btn btn-sm btn-outline-primary me-1" onclick="lookupItem('${scan.code}')" title="Lookup">
              <i class="bi bi-search"></i>
            </button>
            <button class="btn btn-outline-danger btn-sm" onclick="removeScan(${scan.id})">
              <i class="bi bi-trash"></i> Remove
          </button>
          </div>
        </div>
      </div>
    `;
  }).join('');
}

function updateScanCount() {
  document.getElementById('scanCount').textContent = scanHistory.length;
}

function updateStatus(status, message) {
  const indicator = document.getElementById('statusIndicator');
  const text = document.getElementById('statusText');
  
  indicator.className = `status-indicator status-${status}`;
  text.textContent = message;
}

function updateCameraStatus(status, info = '') {
  const cameraStatus = document.getElementById('cameraStatus');
  const cameraInfo = document.getElementById('cameraInfo');
  
  if (cameraStatus) {
    cameraStatus.textContent = `Camera: ${status}`;
  }
  
  if (cameraInfo) {
    if (info) {
      cameraInfo.textContent = info;
      cameraInfo.style.display = 'inline';
    } else {
      cameraInfo.style.display = 'none';
    }
  }
}

function filterHistory(type) {
  const items = document.querySelectorAll('.scan-item');
  
  items.forEach(item => {
    if (type === 'all' || item.dataset.type === type) {
      item.style.display = 'block';
    } else {
      item.style.display = 'none';
    }
  });
}

async function lookupItem(code) {
  try {
    // First try to find in local data
    let item = inventoryData.find(item => 
      item.itemCode === code || 
      item.id.toString() === code ||
      `${item.itemCode}-${item.id}` === code
    );
    
    // If not found locally, try API
    if (!item && inventoryData.length > 0) {
      try {
        const response = await apiCall(`/inventory/search?code=${encodeURIComponent(code)}`);
        if (response.success && response.data) {
          item = mapInventoryData([response.data])[0];
        }
      } catch (error) {
        console.log('API search failed, using local data only');
      }
    }
    
    if (item) {
      currentItem = item;
      showItemDetails(item);
    } else {
      showMessage(`Item with code "${code}" not found in inventory.`, 'warning');
    }
  } catch (error) {
    console.error('Error looking up item:', error);
    showMessage('Error looking up item', 'error');
  }
}

function showItemDetails(item) {
  const modal = new bootstrap.Modal(document.getElementById('itemLookupModal'));
  const content = document.getElementById('itemDetailsContent');
  
  // Get category and warehouse names
  const category = categoriesData.find(c => c.category_id === item.categoryId);
  const warehouse = warehousesData.find(w => w.warehouse_id === item.warehouseId);
  
  content.innerHTML = `
    <div class="item-details">
      <div class="row g-3">
        <div class="col-md-6">
          <strong>Item Code:</strong> ${item.itemCode}<br>
          <strong>Product Name:</strong> ${item.productName}<br>
          <strong>Status:</strong> <span class="badge ${item.status === 'active' ? 'bg-success' : 'bg-danger'}">${item.status}</span>
        </div>
        <div class="col-md-6">
          <strong>Current Quantity:</strong> ${item.totalQuantity} ${item.unitOfMeasure}<br>
          <strong>Price:</strong> ‚Ç±${item.price}
        </div>
        <div class="col-md-6">
          <strong>Category:</strong> ${category?.category_name || 'N/A'}<br>
          <strong>Warehouse:</strong> ${warehouse?.warehouse_name || 'N/A'}
        </div>
        <div class="col-md-6">
          <strong>Product Category:</strong> ${item.productCategory || 'N/A'}<br>
          <strong>Last Updated:</strong> ${new Date(item.updatedAt).toLocaleString()}
        </div>
      </div>
      
      <div class="quantity-controls">
        <label class="form-label">Update Quantity:</label>
        <div class="d-flex align-items-center gap-2">
          <button class="btn btn-outline-secondary btn-sm" onclick="adjustQuantity(-1)">-</button>
          <input type="number" class="form-control" id="newQuantity" value="${item.totalQuantity}" min="0" style="width: 100px;">
          <button class="btn btn-outline-secondary btn-sm" onclick="adjustQuantity(1)">+</button>
          <span class="text-muted">${item.unitOfMeasure}</span>
        </div>
      </div>
      
      <div class="quantity-actions">
        <button class="btn btn-sm btn-success" onclick="setQuickQuantity(0)">Set to 0</button>
        <button class="btn btn-sm btn-warning" onclick="setQuickQuantity(10)">+10</button>
        <button class="btn btn-sm btn-info" onclick="setQuickQuantity(50)">+50</button>
        <button class="btn btn-sm btn-primary" onclick="setQuickQuantity(100)">+100</button>
      </div>
      
      <div class="barcode-section mt-3">
        <h6>Generated Barcodes:</h6>
        <div class="row g-2">
          <div class="col-md-4">
            <div class="barcode-item">
              <strong>Item Code:</strong> ${item.itemCode}
              <div class="barcode-display" id="barcode-${item.itemCode}"></div>
              <button class="btn btn-sm btn-outline-primary mt-1" onclick="generateBarcode('${item.itemCode}', '${item.itemCode}')">
                <i class="bi bi-upc-scan"></i> Generate
              </button>
            </div>
          </div>
          <div class="col-md-4">
            <div class="barcode-item">
              <strong>ID:</strong> ${item.id}
              <div class="barcode-display" id="barcode-id-${item.id}"></div>
              <button class="btn btn-sm btn-outline-primary mt-1" onclick="generateBarcode('${item.id}', 'id-${item.id}')">
                <i class="bi bi-upc-scan"></i> Generate
              </button>
            </div>
          </div>
          <div class="col-md-4">
            <div class="barcode-item">
              <strong>Combined:</strong> ${item.itemCode}-${item.id}
              <div class="barcode-display" id="barcode-combined-${item.id}"></div>
              <button class="btn btn-sm btn-outline-primary mt-1" onclick="generateBarcode('${item.itemCode}-${item.id}', 'combined-${item.id}')">
                <i class="bi bi-upc-scan"></i> Generate
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  `;
  
  modal.show();
}

function adjustQuantity(delta) {
  const input = document.getElementById('newQuantity');
  const currentValue = parseInt(input.value) || 0;
  const newValue = Math.max(0, currentValue + delta);
  input.value = newValue;
}

function setQuickQuantity(value) {
  const input = document.getElementById('newQuantity');
  if (value === 0) {
    input.value = 0;
  } else {
    const currentValue = parseInt(input.value) || 0;
    input.value = currentValue + value;
  }
}

async function updateInventoryQuantity() {
  if (!currentItem) return;
  
  const newQuantity = parseInt(document.getElementById('newQuantity').value);
  if (isNaN(newQuantity) || newQuantity < 0) {
    showMessage('Please enter a valid quantity', 'error');
    return;
  }
  
  try {
    const response = await apiCall(`/inventory/${currentItem.id}`, {
      method: 'PUT',
      body: JSON.stringify({
        total_quantity: newQuantity
      })
    });
    
    if (response.success) {
      // Update local data
      currentItem.totalQuantity = newQuantity;
      const index = inventoryData.findIndex(item => item.id === currentItem.id);
      if (index !== -1) {
        inventoryData[index].totalQuantity = newQuantity;
      }
      
      showMessage(`Quantity updated successfully for ${currentItem.productName}`, 'success');
      bootstrap.Modal.getInstance(document.getElementById('itemLookupModal')).hide();
      
      // Log activity
      logActivity('update', currentItem.itemCode, 'quantity', currentItem.productName, 'success');
      
      // Refresh notifications
      refreshNotifications();
    } else {
      showMessage(response.message || 'Failed to update quantity', 'error');
    }
  } catch (error) {
    console.error('Error updating quantity:', error);
    showMessage('Error updating quantity', 'error');
  }
}

function quickUpdate(code) {
  lookupItem(code);
}

async function removeScan(scanId) {
  try {
    // First try to delete from database if it has a database ID
    const scan = scanHistory.find(s => s.id === scanId);
    
    if (scan && scan.dbId) {
      console.log('Attempting to delete scan from database:', scan.dbId);
      
      const response = await apiCall(`/scan-history/${scan.dbId}`, {
        method: 'DELETE'
      });
      
      if (response.success) {
        console.log('Scan deleted from database successfully');
      } else {
        console.log('Failed to delete scan from database:', response);
        // Continue with local deletion even if database fails
      }
    } else {
      console.log('Scan has no database ID, deleting locally only');
    }
    
    // Remove from local history
    scanHistory = scanHistory.filter(scan => scan.id !== scanId);
    updateScanHistory();
    updateScanCount();
    
    showMessage('Scan removed from history', 'success');
    logActivity('remove_scan', `Removed scan ID: ${scanId}`);
    
  } catch (error) {
    console.error('Error removing scan:', error);
    showMessage('Error removing scan from history', 'error');
  }
}

function exportScanHistory() {
  if (scanHistory.length === 0) {
    alert('No scan history to export.');
    return;
  }
  
  const csvContent = "data:text/csv;charset=utf-8," 
    + "Code,Type,Timestamp,Status,Item,Quantity\n"
    + scanHistory.map(scan => 
        `${scan.code},${scan.type},${scan.timestamp.toISOString()},${scan.status},${scan.item?.productName || 'N/A'},${scan.item?.totalQuantity || 'N/A'}`
      ).join("\n");
  
  const encodedUri = encodeURI(csvContent);
  const link = document.createElement("a");
  link.setAttribute("href", encodedUri);
  link.setAttribute("download", `scan_history_${new Date().toISOString().split('T')[0]}.csv`);
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
}

async function clearScanHistory() {
  if (confirm('Are you sure you want to clear all scan history? This will clear both local and database history.')) {
    try {
      // Clear from database
      const response = await apiCall('/scan-history', {
        method: 'DELETE'
      });
      
      if (response.success) {
        showMessage('Database scan history cleared successfully', 'success');
      }
    } catch (error) {
      console.error('Error clearing database history:', error);
      showMessage('Database history could not be cleared', 'warning');
    }
    
    // Clear local history
    scanHistory = [];
    updateScanHistory();
    updateScanCount();
    document.getElementById('scanResult').style.display = 'none';
    showMessage('Local scan history cleared', 'info');
  }
}

async function loadScanHistoryFromDatabase() {
  try {
    console.log('Loading scan history from database...');
    showLoading(true);
    const response = await apiCall('/scan-history');
    
    console.log('Database response:', response);
    
    if (response.success && response.data) {
      console.log('Received scan history from database:', response.data);
      
      // Convert database format to local format
      const dbHistory = response.data.map(dbScan => ({
        id: dbScan.id,
        code: dbScan.scanned_code,
        type: dbScan.scan_type,
        timestamp: new Date(dbScan.created_at),
        status: dbScan.scan_status,
        item: dbScan.item_id ? inventoryData.find(item => item.id === dbScan.item_id) : null,
        itemId: dbScan.item_id,
        productName: dbScan.product_name,
        quantity: dbScan.quantity,
        dbId: dbScan.id,
        dbCreatedAt: dbScan.created_at,
        notes: dbScan.notes
      }));
      
      // Merge with local history, avoiding duplicates
      const existingIds = new Set(scanHistory.map(scan => scan.dbId || scan.id));
      const newDbScans = dbHistory.filter(dbScan => !existingIds.has(dbScan.dbId));
      
      if (newDbScans.length > 0) {
        scanHistory = [...newDbScans, ...scanHistory];
        console.log(`Added ${newDbScans.length} new scans from database`);
      } else {
        console.log('No new scans found in database');
      }
      
      updateScanHistory();
      updateScanCount();
    } else {
      console.log('No scan history data received from database');
    }
  } catch (error) {
    console.error('Error loading scan history from database:', error);
    showMessage('Could not load scan history from database', 'warning');
  } finally {
    showLoading(false);
  }
}

function focusInput() {
  setTimeout(() => {
    document.getElementById('manualInput').focus();
  }, 100);
}

function playBeep() {
  try {
    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
    const oscillator = audioContext.createOscillator();
    const gainNode = audioContext.createGain();
    
    oscillator.connect(gainNode);
    gainNode.connect(audioContext.destination);
    
    oscillator.frequency.value = 800;
    oscillator.type = 'square';
    
    gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);
    
    oscillator.start(audioContext.currentTime);
    oscillator.stop(audioContext.currentTime + 0.1);
  } catch (error) {
    console.log('Could not play beep sound');
  }
}

// Auto-focus input when page becomes visible
document.addEventListener('visibilitychange', function() {
  if (!document.hidden) {
    focusInput();
  }
});

// Cleanup camera when page is unloaded
window.addEventListener('beforeunload', function() {
  if (isCameraActive) {
    console.log('üßπ Cleaning up camera before page unload...');
    stopCameraBarcodeScanner();
  }
});

// Cleanup camera when page loses focus
document.addEventListener('visibilitychange', function() {
  if (document.hidden && isCameraActive) {
    console.log('üëÅÔ∏è Page hidden, stopping camera...');
    stopCameraBarcodeScanner();
  }
});


async function fetchUser() {
  try {
    const response = await apiCall('/user');
    if (response.success && response.data) {
      currentUser = response.data;
      displayUser(response.data);
    }
  } catch (error) {
    console.error('Failed to fetch user:', error);
    // Use default user data
    currentUser = { username: 'scanner' };
    displayUser({ username: 'scanner' });
  }
}

function displayUser(user) {
  const username = user.username.charAt(0).toUpperCase() + user.username.slice(1);
  document.getElementById('userName').textContent = username;

  const initials = username.substring(0, 2).toUpperCase();
  const userAvatar = document.getElementById('userAvatar');
  if (userAvatar) {
    userAvatar.textContent = initials;
  }

  const profileAvatar = document.getElementById('profileAvatar');
  if (profileAvatar) {
    profileAvatar.textContent = initials;
  }

  const userFullNameDropdown = document.getElementById('userFullNameDropdown');
  const userEmailDropdown = document.getElementById('userEmailDropdown');
  if (userFullNameDropdown) {
    userFullNameDropdown.textContent = username;
  }
  if (userEmailDropdown) {
    userEmailDropdown.textContent = `${user.username}@foxcontrolhub.com`;
  }
}

// Notifications and user helpers
  async function loadNotifications() {
    try {
      const response = await fetch('/api/notifications?limit=none');
      const result = await response.json();
      if (result.success) displayNotifications(result.data);
    } catch (e) { console.error('Error loading notifications:', e); }
  }
  async function loadNotificationCount() {
    try {
      const response = await fetch('/api/notifications/unread-count');
      const result = await response.json();
      if (result.success) updateNotificationCount(result.count || (result.data && result.data.count) || 0);
    } catch (e) { console.error('Error loading notification count:', e); }
  }
  function displayNotifications(notifications) {
    const list = document.querySelector('.notification-list');
    if (!list) return;
    list.innerHTML = '';
    (notifications || []).forEach(n => {
      const div = document.createElement('div');
      div.className = `notification-item ${n.is_read ? '' : 'notification-unread'}`;
      div.setAttribute('data-id', n.id);
      div.innerHTML = `
        <div class="d-flex align-items-start">
          <div class="flex-grow-1" onclick="markNotificationAsRead(${n.id})">
            <div class="notification-title">${n.title}</div>
            <div class="notification-text">${n.message}</div>
            <div class="notification-time">${formatTimeAgo(n.created_at)}</div>
          </div>
          <div class="ms-2">
            <button class="btn btn-sm btn-outline-danger" onclick="event.stopPropagation(); deleteNotification(${n.id})" title="Delete notification">
              <i class="bi bi-trash"></i>
            </button>
          </div>
        </div>
      `;
      list.appendChild(div);
    });
  }
  function updateNotificationCount(count) {
    const badge = document.getElementById('notificationCount');
    if (!badge) return;
    badge.textContent = count;
    badge.style.display = count > 0 ? 'flex' : 'none';
  }
  async function markNotificationAsRead(id) {
    try {
      await fetch(`/api/notifications/${id}/read`, { method: 'POST' });
      await loadNotificationCount();
      await loadNotifications();
    } catch (e) { console.error('Error marking read:', e); }
  }
  async function markAllAsRead() {
    try {
      await fetch('/api/notifications/read-all', { method: 'POST' });
      await loadNotificationCount();
      await loadNotifications();
    } catch (e) { console.error('Error mark all read:', e); }
  }

  async function deleteNotification(id) {
    if (!confirm('Are you sure you want to delete this notification?')) {
      return;
    }
    
    try {
      const response = await fetch(`/api/notifications/${id}`, {
        method: 'DELETE'
      });
      const result = await response.json();
      if (result.success) {
        // Remove the notification from the UI
        const notificationItem = document.querySelector(`[data-id="${id}"]`);
        if (notificationItem) {
          notificationItem.remove();
        }
        
        // Reload notifications and count to ensure consistency
        loadNotifications();
        loadNotificationCount();
      }
    } catch (error) {
      console.error('Failed to delete notification:', error);
      alert('Failed to delete notification. Please try again.');
    }
  }
  function formatTimeAgo(dateString) {
    const date = new Date(dateString);
    const now = new Date();
    const diff = Math.floor((now - date) / 1000);
    if (diff < 60) return 'Just now';
    if (diff < 3600) return `${Math.floor(diff / 60)} minutes ago`;
    if (diff < 86400) return `${Math.floor(diff / 3600)} hours ago`;
    return `${Math.floor(diff / 86400)} days ago`;
  }
  async function fetchUser() {
    try {
      const response = await apiCall('/user');
      if (response.success && response.data) {
        displayUser(response.data);
      }
    } catch (error) {
      console.error('Failed to fetch user:', error);
    }
  }


function addNotification(message, type) {
  // Add to notifications (would normally be done server-side)
  try {
    apiCall('/notifications', {
      method: 'POST',
      body: JSON.stringify({
        title: 'Scanner Activity',
        message: message,
        type: type
      })
    });
  } catch (error) {
    console.log('Could not create notification');
  }
}

function refreshNotifications() {
  loadNotifications();
  loadNotificationCount();
}

// Modal functions
function showSettingsModal() {
  new bootstrap.Modal(document.getElementById('settingsModal')).show();
}

function showProfileModal() {
  new bootstrap.Modal(document.getElementById('profileModal')).show();
}

function showActivityLog() {
  populateActivityLog();
  new bootstrap.Modal(document.getElementById('activityModal')).show();
}

function saveSettings() {
  // Get settings data
  scanTimeout = parseInt(document.getElementById('scanTimeout').value) || 30;
  autoLookup = document.getElementById('autoLookup').checked;
  playBeepSound = document.getElementById('playBeepSound').checked;
  
  // Save to localStorage
  localStorage.setItem('scannerSettings', JSON.stringify({
    scanTimeout,
    autoLookup,
    playBeepSound,
    defaultScannerMode: document.getElementById('defaultScannerMode').value,
    historyLimit: document.getElementById('historyLimit').value,
    dateFormat: document.getElementById('dateFormat').value
  }));
  
  showMessage('Settings saved successfully!', 'success');
  bootstrap.Modal.getInstance(document.getElementById('settingsModal')).hide();
}

function saveProfile() {
  const profileData = {
    firstName: document.getElementById('firstName').value,
    lastName: document.getElementById('lastName').value,
    email: document.getElementById('email').value,
    phone: document.getElementById('phone').value,
    department: document.getElementById('department').value,
    bio: document.getElementById('bio').value
  };
  
  // Save to localStorage (in real app, would save to server)
  localStorage.setItem('userProfile', JSON.stringify(profileData));
  
  showMessage('Profile updated successfully!', 'success');
  bootstrap.Modal.getInstance(document.getElementById('profileModal')).hide();
}

async function logout() {
  if (confirm('Are you sure you want to sign out?')) {
    try {
      const response = await fetch('/logout', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        }
      });
      
      const data = await response.json();
      
      if (data.success) {
        window.location.href = '/loginpage.html';
      } else {
        alert('Error signing out. Please try again.');
      }
    } catch (error) {
      console.error('Logout error:', error);
      window.location.href = '/loginpage.html';
    }
  }
}

// Activity logging
function logActivity(action, code, type, item, status) {
  const activity = {
    timestamp: new Date(),
    action: action,
    code: code,
    type: type,
    item: item,
    status: status
  };
  
  // Save to localStorage (in real app, would save to server)
  let activityLog = JSON.parse(localStorage.getItem('activityLog') || '[]');
  activityLog.unshift(activity);
  
  // Keep only last 1000 activities
  if (activityLog.length > 1000) {
    activityLog = activityLog.slice(0, 1000);
  }
  
  localStorage.setItem('activityLog', JSON.stringify(activityLog));
}

function populateActivityLog() {
  const tbody = document.getElementById('activityLogBody');
  const activityLog = JSON.parse(localStorage.getItem('activityLog') || '[]');
  
  tbody.innerHTML = activityLog.map(activity => `
    <tr>
      <td>${new Date(activity.timestamp).toLocaleString()}</td>
      <td>
        <span class="badge ${
          activity.action === 'scan' ? 'bg-info' :
          activity.action === 'update' ? 'bg-warning' :
          'bg-secondary'
        }">${activity.action}</span>
      </td>
      <td>${activity.code}</td>
      <td>${activity.type}</td>
      <td>${activity.item}</td>
      <td>
        <span class="badge ${
          activity.status === 'success' || activity.status === 'found' ? 'bg-success' :
          activity.status === 'not_found' ? 'bg-warning' :
          'bg-danger'
        }">${activity.status}</span>
      </td>
    </tr>
  `).join('');
}

function exportActivityLog() {
  const activityLog = JSON.parse(localStorage.getItem('activityLog') || '[]');
  
  if (activityLog.length === 0) {
    alert('No activity log to export.');
    return;
  }
  
  const csvContent = "data:text/csv;charset=utf-8," 
    + "Timestamp,Action,Code,Type,Item,Status\n"
    + activityLog.map(activity => 
        `${activity.timestamp},${activity.action},${activity.code},${activity.type},${activity.item},${activity.status}`
      ).join("\n");
  
  const encodedUri = encodeURI(csvContent);
  const link = document.createElement("a");
  link.setAttribute("href", encodedUri);
  link.setAttribute("download", `activity_log_${new Date().toISOString().split('T')[0]}.csv`);
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
}

// Load settings on startup
document.addEventListener('DOMContentLoaded', function() {
  const settings = JSON.parse(localStorage.getItem('scannerSettings') || '{}');
  
  if (settings.scanTimeout) {
    scanTimeout = settings.scanTimeout;
    document.getElementById('scanTimeout').value = scanTimeout;
  }
  
  if (settings.autoLookup !== undefined) {
    autoLookup = settings.autoLookup;
    document.getElementById('autoLookup').checked = autoLookup;
  }
  
  if (settings.playBeepSound !== undefined) {
    playBeepSound = settings.playBeepSound;
    document.getElementById('playBeepSound').checked = playBeepSound;
  }
  
  if (settings.defaultScannerMode) {
    scannerMode = settings.defaultScannerMode;
    updateScannerMode();
  }
});

// Manual data refresh function
async function loadInventoryData() {
  try {
    showMessage('Refreshing inventory data...', 'info');
    await loadInitialData();
    showMessage('Inventory data refreshed successfully!', 'success');
  } catch (error) {
    console.error('Error refreshing inventory data:', error);
    showMessage('Error refreshing inventory data', 'error');
  }
}

// Barcode generation functions
function populateBarcodeItems() {
  const grid = document.getElementById('barcodeItemsGrid');
  
  if (!inventoryData || inventoryData.length === 0) {
    grid.innerHTML = `
      <div class="text-center text-muted py-4">
        <i class="bi bi-inbox" style="font-size: 2rem;"></i>
        <p>No inventory items found. Please refresh data.</p>
      </div>
    `;
    return;
  }
  
  grid.innerHTML = inventoryData.map(item => {
    const category = categoriesData.find(c => c.category_id === item.categoryId);
    const warehouse = warehousesData.find(w => w.warehouse_id === item.warehouseId);
    
    return `
      <div class="barcode-item-card">
        <h6>${item.productName}</h6>
        <div class="item-info">
          <strong>Code:</strong> ${item.itemCode}<br>
          <strong>Category:</strong> ${category?.category_name || 'N/A'}<br>
          <strong>Warehouse:</strong> ${warehouse?.warehouse_name || 'N/A'}<br>
          <strong>Quantity:</strong> ${item.totalQuantity} ${item.unitOfMeasure}
        </div>
        
        <div class="barcode-preview" id="barcode-preview-${item.id}">
          <span class="text-muted">Click generate to create barcode</span>
        </div>
        
        <div class="barcode-actions">
          <button class="btn btn-sm btn-outline-primary" onclick="generateBarcode('${item.itemCode}', 'preview-${item.id}')">
            <i class="bi bi-upc-scan"></i> Item Code
          </button>
          <button class="btn btn-sm btn-outline-secondary" onclick="generateBarcode('${item.id}', 'preview-${item.id}')">
            <i class="bi bi-hash"></i> ID
          </button>
          <button class="btn btn-sm btn-outline-info" onclick="generateBarcode('${item.itemCode}-${item.id}', 'preview-${item.id}')">
            <i class="bi bi-link"></i> Combined
          </button>
        </div>
      </div>
    `;
  }).join('');
}

function populateBarcodeFilters() {
  const categoryFilter = document.getElementById('barcodeCategoryFilter');
  const warehouseFilter = document.getElementById('barcodeWarehouseFilter');
  
  // Populate category filter
  if (categoriesData && categoriesData.length > 0) {
    categoryFilter.innerHTML = '<option value="">All Categories</option>' +
      categoriesData.map(cat => `<option value="${cat.category_id}">${cat.category_name}</option>`).join('');
  }
  
  // Populate warehouse filter
  if (warehousesData && warehousesData.length > 0) {
    warehouseFilter.innerHTML = '<option value="">All Warehouses</option>' +
      warehousesData.map(wh => `<option value="${wh.warehouse_id}">${wh.warehouse_name}</option>`).join('');
  }
}

function filterBarcodeItems() {
  const searchTerm = document.getElementById('barcodeSearchInput').value.toLowerCase();
  const categoryFilter = document.getElementById('barcodeCategoryFilter').value;
  const warehouseFilter = document.getElementById('barcodeWarehouseFilter').value;
  
  const filteredItems = inventoryData.filter(item => {
    const matchesSearch = !searchTerm || 
      item.productName.toLowerCase().includes(searchTerm) ||
      item.itemCode.toLowerCase().includes(searchTerm);
    
    const matchesCategory = !categoryFilter || item.categoryId === categoryFilter;
    const matchesWarehouse = !warehouseFilter || item.warehouseId === warehouseFilter;
    
    return matchesSearch && matchesCategory && matchesWarehouse;
  });
  
  const grid = document.getElementById('barcodeItemsGrid');
  
  if (filteredItems.length === 0) {
    grid.innerHTML = `
      <div class="text-center text-muted py-4">
        <i class="bi bi-search" style="font-size: 2rem;"></i>
        <p>No items match your filters.</p>
      </div>
    `;
    return;
  }
  
  grid.innerHTML = filteredItems.map(item => {
    const category = categoriesData.find(c => c.category_id === item.categoryId);
    const warehouse = warehousesData.find(w => w.warehouse_id === item.warehouseId);
    
    return `
      <div class="barcode-item-card">
        <h6>${item.productName}</h6>
        <div class="item-info">
          <strong>Code:</strong> ${item.itemCode}<br>
          <strong>Category:</strong> ${category?.category_name || 'N/A'}<br>
          <strong>Warehouse:</strong> ${warehouse?.warehouse_name || 'N/A'}<br>
          <strong>Quantity:</strong> ${item.totalQuantity} ${item.unitOfMeasure}
        </div>
        
        <div class="barcode-preview" id="barcode-preview-${item.id}">
          <span class="text-muted">Click generate to create barcode</span>
        </div>
        
        <div class="barcode-actions">
          <button class="btn btn-sm btn-outline-primary" onclick="generateBarcode('${item.itemCode}', 'preview-${item.id}')">
            <i class="bi bi-upc-scan"></i> Item Code
          </button>
          <button class="btn btn-sm btn-outline-secondary" onclick="generateBarcode('${item.id}', 'preview-${item.id}')">
            <i class="bi bi-hash"></i> ID
          </button>
          <button class="btn btn-sm btn-outline-info" onclick="generateBarcode('${item.itemCode}-${item.id}', 'preview-${item.id}')">
            <i class="bi bi-link"></i> Combined
          </button>
        </div>
      </div>
    `;
  }).join('');
}

async function startCameraBarcodeScanner() {
  try {
    if (!window.ZXing || !ZXing.BrowserMultiFormatReader) {
      console.warn('ZXing not loaded; skipping camera scanner');
      showMessage('Barcode scanning library not loaded. Please refresh the page and try again.', 'error');
      updateStatus('error', 'ZXing library not available');
      updateCameraStatus('Library not loaded');
      return;
    }
    if (scannerMode !== 'barcode') return;

    // Check if camera is already active
    if (isCameraActive) {
      console.log('‚ö†Ô∏è Camera is already active, stopping previous session...');
      stopCameraBarcodeScanner();
      // Wait a bit for cleanup
      setTimeout(() => startCameraBarcodeScanner(), 500);
      return;
    }

    // Check camera permissions and get initial stream
    let testStream = null;
    try {
      testStream = await navigator.mediaDevices.getUserMedia({ 
        video: { 
          width: { ideal: 1280 },
          height: { ideal: 720 },
          facingMode: 'environment' // Prefer rear camera
        } 
      });
      console.log('‚úÖ Camera permissions granted and test stream created');
    } catch (permissionError) {
      console.error('‚ùå Camera permission error:', permissionError);
      if (permissionError.name === 'NotAllowedError') {
        showMessage('Camera access denied. Please allow camera permissions in your browser.', 'error');
        updateStatus('error', 'Camera permission denied');
        updateCameraStatus('Permission denied');
        return;
      } else if (permissionError.name === 'NotFoundError') {
        showMessage('No camera found on this device.', 'warning');
        updateStatus('error', 'No camera found');
        updateCameraStatus('Not found');
        return;
      } else if (permissionError.name === 'NotReadableError') {
        showMessage('Camera is already in use by another application.', 'warning');
        updateStatus('error', 'Camera in use');
        updateCameraStatus('In use by another app');
        return;
      }
      throw permissionError;
    }

    const video = document.getElementById('barcodeVideo');
    if (!video) return;

    // Stop any existing video streams first
    if (video.srcObject) {
      const tracks = video.srcObject.getTracks();
      tracks.forEach(track => track.stop());
      video.srcObject = null;
    }

    // Reset video element safely
    try {
      video.pause();
      video.currentTime = 0;
      
      // Ensure video properties are set correctly
      video.autoplay = true;
      video.playsInline = true;
      video.muted = true;
      video.controls = false;
      
      // Remove any existing error state
      if (video.error) {
        console.log('üßπ Clearing previous video error state');
      }
      
      // Wait a bit for video element to reset
      await new Promise(resolve => setTimeout(resolve, 100));
      
    } catch (resetError) {
      console.warn('‚ö†Ô∏è Video reset error (non-critical):', resetError);
      // Continue anyway
    }

    // Create new code reader instance if needed
    if (!codeReader) {
      codeReader = new ZXing.BrowserMultiFormatReader();
    } else {
      // Reset existing code reader
      try {
        codeReader.reset();
      } catch (resetError) {
        console.log('Code reader reset error (normal):', resetError.message);
      }
    }

    // Prefer environment (rear) camera
    codeReader
      .listVideoInputDevices()
      .then(videoInputDevices => {
        if (!videoInputDevices || videoInputDevices.length === 0) {
          console.warn('‚ö†Ô∏è No video input devices found, will use facing mode');
          // Don't throw error, continue with facing mode
        }

        // Find the best camera device
        let preferredDeviceId = null;
        let videoConstraints = {};
        
        if (videoInputDevices && videoInputDevices.length > 0) {
          console.log('üì± Available video devices:', videoInputDevices.map(d => ({
            deviceId: d.deviceId,
            label: d.label,
            groupId: d.groupId
          })));
          
          // Try to find a rear camera first
          const rearCamera = videoInputDevices.find(d => 
            d.label && /back|rear|environment/i.test(d.label)
          );
          
          if (rearCamera) {
            preferredDeviceId = rearCamera.deviceId;
            console.log('üìπ Using rear camera:', rearCamera.label);
          } else {
            // Fallback to first available camera
            preferredDeviceId = videoInputDevices[0].deviceId;
            console.log('üìπ Using first available camera:', videoInputDevices[0].label);
          }
          
          // Validate device ID
          if (preferredDeviceId && preferredDeviceId.length > 0) {
            // Build video constraints with device ID
            videoConstraints = {
              deviceId: { exact: preferredDeviceId },
              width: { ideal: 1280, min: 640 },
              height: { ideal: 720, min: 480 },
              frameRate: { ideal: 30, min: 15 }
            };
            console.log('üéØ Using specific device ID:', preferredDeviceId);
          } else {
            // Invalid device ID, fallback to facing mode
            console.warn('‚ö†Ô∏è Invalid device ID, falling back to facing mode');
            videoConstraints = {
              facingMode: 'environment',
              width: { ideal: 1280, min: 640 },
              height: { ideal: 720, min: 480 },
              frameRate: { ideal: 30, min: 15 }
            };
          }
        } else {
          // No specific devices, use facing mode
          videoConstraints = {
            facingMode: 'environment',
            width: { ideal: 1280, min: 640 },
            height: { ideal: 720, min: 480 },
            frameRate: { ideal: 30, min: 15 }
          };
          console.log('üìπ Using facing mode (no specific device)');
        }
        
        updateStatus('scanning', 'Starting camera...');
        
        // Create video stream and start decoding
        createVideoStream(videoConstraints, video, testStream);
      })
      .catch(err => {
        console.error('Error starting camera scanner:', err);
        
        // Handle specific camera errors
        if (err.name === 'NotAllowedError') {
          showMessage('Camera access denied. Please allow camera permissions.', 'error');
          updateStatus('error', 'Camera permission denied');
          updateCameraStatus('Permission denied');
        } else if (err.name === 'NotFoundError') {
          showMessage('No camera found on this device.', 'warning');
          updateStatus('error', 'No camera found');
          updateCameraStatus('Not found');
        } else if (err.name === 'NotReadableError') {
          showMessage('Camera is already in use by another application.', 'warning');
          updateStatus('error', 'Camera in use');
          updateCameraStatus('In use by another app');
        } else {
          showMessage('Could not access camera for scanning', 'warning');
          updateStatus('error', 'Camera access failed');
          updateCameraStatus('Access failed');
        }
        
        // Reset camera state
        isCameraActive = false;
        cameraStream = null;
        
        // Add a manual retry button to the scanner area
        const scannerArea = document.getElementById('scannerArea');
        if (scannerArea && !scannerArea.querySelector('.manual-retry-btn')) {
          const retryBtn = document.createElement('button');
          retryBtn.className = 'btn btn-warning btn-sm manual-retry-btn mt-2';
          retryBtn.innerHTML = '<i class="bi bi-arrow-clockwise"></i> Retry Camera';
          retryBtn.onclick = () => {
            console.log('üîÑ Manual retry requested...');
            stopCameraBarcodeScanner();
            setTimeout(() => {
              if (isScanning) {
                startCameraBarcodeScanner();
              }
            }, 1000);
          };
          scannerArea.appendChild(retryBtn);
        }
      });
  } catch (e) {
    console.error('Camera scanner init error:', e);
    updateStatus('error', 'Camera initialization failed');
    updateCameraStatus('Initialization failed');
    
    // Add a manual retry button to the scanner area
    const scannerArea = document.getElementById('scannerArea');
    if (scannerArea && !scannerArea.querySelector('.manual-retry-btn')) {
      const retryBtn = document.createElement('button');
      retryBtn.className = 'btn btn-warning btn-sm manual-retry-btn mt-2';
      retryBtn.innerHTML = '<i class="bi bi-arrow-clockwise"></i> Retry Camera';
      retryBtn.onclick = () => {
        console.log('üîÑ Manual retry requested...');
        stopCameraBarcodeScanner();
        setTimeout(() => {
          if (isScanning) {
            startCameraBarcodeScanner();
          }
        }, 1000);
      };
      scannerArea.appendChild(retryBtn);
    }
  }
}

async function createVideoStream(videoConstraints, video, testStream) {
  // Validate video element
  if (!video || !(video instanceof HTMLVideoElement)) {
    console.error('‚ùå Invalid video element provided');
    return;
  }
  
  // Stop the test stream and create a new one for the video element
  if (testStream) {
    testStream.getTracks().forEach(track => track.stop());
  }

  // Create a new stream for the video element
  try {
    console.log('üé• Creating video stream with constraints:', videoConstraints);

    const videoStream = await navigator.mediaDevices.getUserMedia({
      video: videoConstraints
    });

    // Set the stream to the video element safely
    try {
      // Ensure video element is in a clean state
      if (video.error) {
        console.log('üßπ Video had previous error, clearing...');
      }
      
      // Set the stream
      video.srcObject = videoStream;
      cameraStream = videoStream;
      activeVideoElement = video;
      isCameraActive = true;
      
      // Update camera status
      updateCameraStatus('Active', `Resolution: ${videoStream.getVideoTracks()[0]?.getSettings()?.width || 'Unknown'}x${videoStream.getVideoTracks()[0]?.getSettings()?.height || 'Unknown'}`);

      // Show camera overlay
      showCameraOverlay(true);

      console.log('‚úÖ Video stream created and set to video element');
    } catch (setError) {
      console.error('‚ùå Error setting video stream:', setError);
      throw setError;
    }
    console.log('üìä Stream tracks:', videoStream.getTracks().map(t => ({
      kind: t.kind,
      label: t.label,
      enabled: t.enabled,
      readyState: t.readyState
    })));

    // Wait for video to be ready before starting decoder
    let videoReady = false;
    
    function onVideoReady() {
      if (videoReady) return;
      videoReady = true;
      
      console.log('üìπ Video is ready, starting decoder...');
      console.log('Video state:', {
        readyState: video.readyState,
        networkState: video.networkState,
        currentTime: video.currentTime,
        duration: video.duration,
        videoWidth: video.videoWidth,
        videoHeight: video.videoHeight
      });
      
      // Clear the timeout
      if (videoReadyTimeout) {
        clearTimeout(videoReadyTimeout);
      }
      
      // Ensure video is visible and properly sized
      video.style.display = 'block';
      video.style.minHeight = '200px';
      
      // Remove any placeholder
      const placeholder = document.querySelector('#videoPlaceholder');
      if (placeholder) {
        placeholder.remove();
      }
      
      // Start the decoder
      startBarcodeDecoder(video);
    }
    
    // Listen for multiple video events to ensure we catch when it's ready
    video.addEventListener('canplay', onVideoReady, { once: true });
    video.addEventListener('loadeddata', onVideoReady, { once: true });
    video.addEventListener('canplaythrough', onVideoReady, { once: true });
    
    // Set a timeout for video readiness
    const videoReadyTimeout = setTimeout(() => {
      if (!videoReady) {
        console.warn('‚ö†Ô∏è Video not ready after timeout, attempting fallback...');
        
        // Try to start decoder anyway
        if (isCameraActive && isScanning) {
          console.log('üîÑ Attempting to start decoder despite video timeout...');
          
          // Force video to play and then start decoder
          try {
            video.play().then(() => {
              console.log('üé¨ Video play successful, starting decoder...');
              startBarcodeDecoder(video);
            }).catch(playError => {
              console.warn('‚ö†Ô∏è Video play failed, starting decoder anyway:', playError);
              startBarcodeDecoder(video);
            });
          } catch (playError) {
            console.warn('‚ö†Ô∏è Video play error, starting decoder anyway:', playError);
            startBarcodeDecoder(video);
          }
        }
      }
    }, 3000); // Reduced timeout to 3 seconds

    // Handle video errors
    video.addEventListener('error', function videoErrorListener(e) {
      console.error('‚ùå Video error:', e);
      console.error('Video error details:', {
        error: video.error,
        networkState: video.networkState,
        readyState: video.readyState,
        src: video.src,
        srcObject: video.srcObject
      });
      
      // Clear the timeout
      if (videoReadyTimeout) {
        clearTimeout(videoReadyTimeout);
      }
      
      video.removeEventListener('error', videoErrorListener);
      
      // Log additional diagnostic information
      if (video.error) {
        console.error('Video error code:', video.error.code);
        console.error('Video error message:', video.error.message);
        
        // Handle specific error codes
        switch (video.error.code) {
          case 4: // MEDIA_ELEMENT_ERROR: Empty src attribute
            console.warn('‚ö†Ô∏è Empty src attribute error - this should not happen with srcObject');
            break;
          case 1: // MEDIA_ERR_ABORTED
            console.warn('‚ö†Ô∏è Media aborted - user or script stopped the media');
            break;
          case 2: // MEDIA_ERR_NETWORK
            console.warn('‚ö†Ô∏è Network error - network error occurred');
            break;
          case 3: // MEDIA_ERR_DECODE
            console.warn('‚ö†Ô∏è Decode error - media decoding failed');
            break;
          default:
            console.warn('‚ö†Ô∏è Unknown video error code:', video.error.code);
        }
      }
      
      // Try to recover from the error
      setTimeout(() => {
        if (isScanning && isCameraActive) {
          console.log('üîÑ Attempting to recover from video error...');
          stopCameraBarcodeScanner();
          setTimeout(() => {
            if (isScanning) {
              startCameraBarcodeScanner();
            }
          }, 1000);
        }
      }, 2000);
      
      showMessage('Video error occurred. Attempting to recover...', 'warning');
      updateStatus('error', 'Video error - recovering');
    });

    // Add additional event listeners for better debugging
    video.addEventListener('loadstart', () => console.log('üìπ Video loadstart event'));
    video.addEventListener('loadedmetadata', () => console.log('üìπ Video loadedmetadata event'));
    video.addEventListener('loadeddata', () => console.log('üìπ Video loadeddata event'));
    video.addEventListener('canplay', () => console.log('üìπ Video canplay event'));
    video.addEventListener('canplaythrough', () => console.log('üìπ Video canplaythrough event'));
    video.addEventListener('playing', () => console.log('üìπ Video playing event'));
    
    // Remove retry button if it exists
    const retryBtn = document.querySelector('.manual-retry-btn');
    if (retryBtn) {
      retryBtn.remove();
    }

  } catch (streamError) {
    console.error('‚ùå Error creating video stream:', streamError);
    console.error('Stream error details:', {
      name: streamError.name,
      message: streamError.message,
      constraint: streamError.constraint
    });

    // Try fallback with simpler constraints
    try {
      console.log('üîÑ Trying fallback with simpler constraints...');
      const fallbackStream = await navigator.mediaDevices.getUserMedia({
        video: {
          facingMode: 'environment',
          width: { min: 320 },
          height: { min: 240 }
        }
      });

      video.srcObject = fallbackStream;
      cameraStream = fallbackStream;
      activeVideoElement = video;
      isCameraActive = true;
      
      // Update camera status for fallback
      updateCameraStatus('Active (Fallback)', 'Using basic camera settings');
      
      // Show camera overlay
      showCameraOverlay(true);

      console.log('‚úÖ Fallback video stream created successfully');
      
      // Start decoder with fallback stream
      startBarcodeDecoder(video);

    } catch (fallbackError) {
      console.error('‚ùå Fallback stream also failed:', fallbackError);
      showMessage('Failed to start camera stream. Please check camera permissions and try again.', 'error');
      updateStatus('error', 'Stream creation failed');
      updateCameraStatus('Stream failed');
      isCameraActive = false;
      cameraStream = null;
      
      // Add a manual retry button to the scanner area
      const scannerArea = document.getElementById('scannerArea');
      if (scannerArea && !scannerArea.querySelector('.manual-retry-btn')) {
        const retryBtn = document.createElement('button');
        retryBtn.className = 'btn btn-warning btn-sm manual-retry-btn mt-2';
        retryBtn.innerHTML = '<i class="bi bi-arrow-clockwise"></i> Retry Camera';
        retryBtn.onclick = () => {
          console.log('üîÑ Manual retry requested...');
          stopCameraBarcodeScanner();
          setTimeout(() => {
            if (isScanning) {
              startCameraBarcodeScanner();
            }
          }, 1000);
        };
        scannerArea.appendChild(retryBtn);
      }
      
      return;
    }
  }
}

function startBarcodeDecoder(video) {
  if (!codeReader || !isScanning) return;
  
  try {
    // Start the decoder
    codeReader.decodeFromVideoDevice(null, video, (result, err, controls) => {
      if (!isScanning) {
        try { 
          if (controls && typeof controls.stop === 'function') {
            controls.stop(); 
          }
        } catch (stopError) {
          console.log('Controls stop error (normal):', stopError.message);
        }
        return;
      }
      
      if (result) {
        const now = Date.now();
        const text = result.getText ? result.getText() : (result.text || '').toString();
        // Throttle duplicate scans within 1.5s
        if (text && (text !== lastScannedCode || now - lastScannedAt > 1500)) {
          lastScannedCode = text;
          lastScannedAt = now;
          processScan(text, 'barcode');
          if (!continuousMode) {
            stopScanning();
          }
        }
      }
    });
    
    console.log('‚úÖ Barcode decoder started successfully');
    updateStatus('scanning', 'Camera active - scanning for barcodes...');
    
  } catch (decoderError) {
    console.error('‚ùå Error starting barcode decoder:', decoderError);
    showMessage('Error starting barcode decoder', 'error');
    updateStatus('error', 'Decoder failed');
    updateCameraStatus('Decoder failed');
  }
}

function stopCameraBarcodeScanner() {
  try {
    console.log('üõë Stopping camera barcode scanner...');
    
    // Stop the code reader
    if (codeReader) {
      try { 
        codeReader.reset(); 
        console.log('‚úÖ Code reader reset');
      } catch (resetError) {
        console.log('‚ö†Ô∏è Code reader reset error (normal):', resetError.message);
      }
    }
    
    // Stop video tracks
    const video = document.getElementById('barcodeVideo');
    if (video) {
      // Pause the video
      try {
        video.pause();
        video.currentTime = 0;
      } catch (pauseError) {
        console.log('‚ö†Ô∏è Video pause error (normal):', pauseError.message);
      }
      
      // Stop all tracks
      if (video.srcObject) {
        try {
          const tracks = video.srcObject.getTracks();
          tracks.forEach(track => {
            if (track && typeof track.stop === 'function') {
              track.stop();
            }
          });
          video.srcObject = null;
          console.log('‚úÖ Video tracks stopped');
        } catch (trackError) {
          console.log('‚ö†Ô∏è Track stop error (normal):', trackError.message);
        }
      }
      
      // Clear the video source but don't set empty src
      // video.src = '';
      // video.load();
    }
    
    activeVideoElement = null;
    isCameraActive = false;
    cameraStream = null;
    
    // Update camera status
    updateCameraStatus('Not active');
    
    // Hide camera overlay
    showCameraOverlay(false);
    
    // Show placeholder again
    showVideoPlaceholder();
    
    console.log('‚úÖ Camera scanner stopped successfully');
    
  } catch (e) {
    console.warn('‚ö†Ô∏è Error stopping camera:', e);
  }
}

</script>
</body>
</html>

